//
// backbone.stickit - v0.6.3
// The MIT License
// Copyright (c) 2012 The New York Times, CMS Group, Matthew DeLambo <delambo@gmail.com> 
//
(function(e){Backbone.Stickit={_handlers:[],addHandler:function(e){e=_.map(_.flatten([e]),function(e){return _.extend({updateModel:!0,updateView:!0,updateMethod:"text"},e)}),this._handlers=this._handlers.concat(e)}},_.extend(Backbone.View.prototype,{_modelBindings:null,unstickit:function(e){_.each(this._modelBindings,_.bind(function(t,n){return e&&t.model!==e?!1:(t.model.off(t.event,t.fn),delete this._modelBindings[n],void 0)},this)),this._modelBindings=_.compact(this._modelBindings),this.$el.off(".stickit"+(e?"."+e.cid:""))},stickit:function(e,t){var i=this,p=e||this.model,f=".stickit."+p.cid,h=t||this.bindings||{};this._modelBindings||(this._modelBindings=[]),this.unstickit(p),_.each(_.keys(h),function(e){var t,v,g,b,m=h[e]||{},k=_.uniqueId();":el"!=e?t=i.$(e):(t=i.$el,e=""),t.length&&(_.isString(m)&&(m={observe:m}),b=u(t,m),g=b.observe,v=_.extend({bindKey:k},b.setOptions||{}),r(i,t,b,p,g),s(i,t,b,p,g),g&&(_.each(b.events||[],function(n){var o=n+f,c=function(e){var n=b.getVal.call(i,t,e,b);a(i,b.updateModel,n,b)&&l(p,g,n,v,i,b)};""===e?i.$el.on(o,c):i.$el.on(o,e,c)}),_.each(_.flatten([g]),function(e){o(p,i,"change:"+e,function(e,n,a){(null==a||a.bindKey!=k)&&d(i,t,b,c(e,g,b,i),e)})}),d(i,t,b,c(p,g,b,i),p,!0)),n(i,b.initialize,t,p,b))}),this.remove=_.wrap(this.remove,function(e){i.unstickit(),e&&e.call(i)})}});var t=function(e,t){var n=(t||"").split("."),i=_.reduce(n,function(e,t){return e[t]},e);return null==i?e:i},n=function(e,t){return t?(_.isString(t)?e[t]:t).apply(e,_.toArray(arguments).slice(2)):void 0},i=function(e){return e.find("option").not(function(){return!this.selected})},a=function(e,t){return _.isBoolean(t)?t:_.isFunction(t)||_.isString(t)?n.apply(this,_.toArray(arguments)):!1},o=function(e,t,n,i){e.on(n,i,t),t._modelBindings.push({model:e,event:n,fn:i})},l=function(e,t,i,a,o,l){l.onSet&&(i=n(o,l.onSet,i,l)),e.set(t,i,a)},c=function(e,t,i,a){var o,l=function(t){var n=i.escape?e.escape(t):e.get(t);return _.isUndefined(n)?"":n};return o=_.isArray(t)?_.map(t,l):l(t),i.onGet?n(a,i.onGet,o,i):o},u=function(e,t){var n=[{updateModel:!1,updateView:!0,updateMethod:"text",update:function(e,t,n,i){e[i.updateMethod](t)},getVal:function(e,t,n){return e[n.updateMethod]()}}];_.each(Backbone.Stickit._handlers,function(t){e.is(t.selector)&&n.push(t)}),n.push(t);var i=_.extend.apply(_,n);return delete i.selector,i},r=function(e,t,n,i,a){var l=["autofocus","autoplay","async","checked","controls","defer","disabled","hidden","loop","multiple","open","readonly","required","scoped","selected"];_.each(n.attributes||[],function(n){var u="",r=n.observe||(n.observe=a),s=function(){var a=_.indexOf(l,n.name,!0)>-1?"prop":"attr",o=c(i,r,n,e);"class"==n.name?(t.removeClass(u).addClass(o),u=o):t[a](n.name,o)};_.each(_.flatten([r]),function(t){o(i,e,"change:"+t,s)}),s()})},s=function(e,t,i,a,l){if(null!=i.visible){var u=function(){var o=i.visible,u=i.visibleFn,r=c(a,l,i,e),s=!!r;(_.isFunction(o)||_.isString(o))&&(s=n(e,o,r,i)),u?n(e,u,t,s,i):s?t.show():t.hide()};_.each(_.flatten([l]),function(t){o(a,e,"change:"+t,u)}),u()}},d=function(e,t,i,o,l,c){a(e,i.updateView,o,i)&&(i.update.call(e,t,o,l,i),c||n(e,i.afterUpdate,t,o,i))};Backbone.Stickit.addHandler([{selector:'[contenteditable="true"]',updateMethod:"html",events:["keyup","change","paste","cut"]},{selector:"input",events:["keyup","change","paste","cut"],update:function(e,t){e.val(t)},getVal:function(e){var t=e.val();return e.is('[type="number"]')?null==t?t:Number(t):t}},{selector:"textarea",events:["keyup","change","paste","cut"],update:function(e,t){e.val(t)},getVal:function(e){return e.val()}},{selector:'input[type="radio"]',events:["change"],update:function(e,t){e.filter('[value="'+t+'"]').prop("checked",!0)},getVal:function(e){return e.filter(":checked").val()}},{selector:'input[type="checkbox"]',events:["change"],update:function(t,n){t.length>1?(n||(n=[]),_.each(t,function(t){_.indexOf(n,e(t).val())>-1?e(t).prop("checked",!0):e(t).prop("checked",!1)})):_.isBoolean(n)?t.prop("checked",n):t.prop("checked",n==t.val())},getVal:function(t){var n;if(t.length>1)n=_.reduce(t,function(t,n){return e(n).prop("checked")&&t.push(e(n).val()),t},[]);else{n=t.prop("checked");var i=t.val();"on"!=i&&null!=i&&(n=n?t.val():null)}return n}},{selector:"select",events:["change"],update:function(i,a,o,l){var c,u=l.selectOptions,r=u&&u.collection||void 0,s=i.prop("multiple");if(!u){u={};var d=function(e){return e.find("option").map(function(){return{value:this.value,label:this.text}}).get()};i.find("optgroup").length?(r={opt_labels:[]},_.each(i.find("optgroup"),function(t){var n=e(t).attr("label");r.opt_labels.push(n),r[n]=d(e(t))})):r=d(i)}u.valuePath=u.valuePath||"value",u.labelPath=u.labelPath||"label";var p=function(n,i,a){u.defaultOption&&(n=_.clone(n),n.unshift("__default__")),_.each(n,function(n){var o=e("<option/>"),l=n,c=function(e,t){o.text(e),l=t,o.data("stickit_bind_val",l),_.isArray(l)||_.isObject(l)||o.val(l)};"__default__"===n?c(u.defaultOption.label,u.defaultOption.value):c(t(n,u.labelPath),t(n,u.valuePath)),!s&&null!=l&&null!=a&&l==a||_.isObject(a)&&_.isEqual(l,a)?o.prop("selected",!0):s&&_.isArray(a)&&_.each(a,function(e){_.isObject(e)&&(e=t(e,u.valuePath)),(e==l||_.isObject(e)&&_.isEqual(l,e))&&o.prop("selected",!0)}),i.append(o)})};i.html("");var f=function(e,n){var i=window;return 0===n.indexOf("this.")&&(i=e),n=n.replace(/^[a-z]*\.(.+)$/,"$1"),t(i,n)};c=_.isString(r)?f(this,r):_.isFunction(r)?n(this,r,i,l):r,c instanceof Backbone.Collection&&(c=c.toJSON()),_.isArray(c)?p(c,i,a):_.each(c.opt_labels,function(t){var n=e("<optgroup/>").attr("label",t);p(c[t],n,a),i.append(n)})},getVal:function(t){var n;return n=t.prop("multiple")?e(i(t).map(function(){return e(this).data("stickit_bind_val")})).get():i(t).data("stickit_bind_val")}}])})(window.jQuery||window.Zepto);